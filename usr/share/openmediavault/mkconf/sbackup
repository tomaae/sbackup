#!/bin/sh

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

OMV_SBACKUP_SCRIPTS_DIR=${OMV_SBACKUP_SCRIPTS_DIR:-"/var/lib/openmediavault/sbackup.d"}
OMV_SBACKUP_SCRIPTS_MASK=${OMV_SBACKUP_SCRIPTS_MASK:-"755"}
OMV_SBACKUP_LOGFILE=${OMV_SBACKUP_LOGFILE:-"/var/log/rsync.log"}

# Create the backup jobs. Each job is configured in a separate script.
mkdir -p ${OMV_SBACKUP_SCRIPTS_DIR}
rm -f ${OMV_SBACKUP_SCRIPTS_DIR}/rsync-*

# Create the scripts regardless if enabled or disabled.
xmlstarlet sel -t -m "//services/sbackup/backuplist/backup" \
  -v "uuid" \
  -i "position() != last()" -n -b \
  ${OMV_CONFIG_FILE} | xmlstarlet unesc |
  while read uuid; do
          filename="${OMV_SBACKUP_SCRIPTS_DIR}/rsync-${uuid}"
          runfile="/var/run/rsync-${uuid}"
          GET_SOURCEFOLDER_PATH=${GET_SOURCEFOLDER_PATH=-m "//system/shares/sharedfolder[uuid=current()/sharedfoldersource]" -v "concat(//system/fstab/mntent[uuid=current()/mntentref]/dir,'/',reldirpath)" -b}
          GET_TARGETFOLDER_PATH=${GET_TARGETFOLDER_PATH=-m "//system/shares/sharedfolder[uuid=current()/sharedfoldertarget]" -v "concat(//system/fstab/mntent[uuid=current()/mntentref]/dir,'/',reldirpath)" -b}
          GET_SOURCE_RELDIR=${GET_SOURCE_RELDIR=-m "//system/shares/sharedfolder[uuid=current()/sharedfoldersource]" -v "reldirpath" -b}
          
          xmlstarlet sel -t -m "//services/sbackup/backuplist/backup[uuid='${uuid}']" \
                -o "# This configuration file is auto-generated." -n \
                -o "# WARNING: Do not edit this file, your changes will be lost." -n \
                -o "enable=" -v "enable" -n \
                -o "wday=" -v "wday" -n \
                -o "hour=" -v "hour" -n \
                -o "minute=" -v "minute" -n \
                -o "uuid=${uuid}" -n \
          			-o "backup_source=" ${GET_SOURCEFOLDER_PATH} -o "/"  -n \
          			-o "backup_target=" ${GET_TARGETFOLDER_PATH} -o "/" ${GET_SOURCE_RELDIR} -o "/"  -n \
          			-o "report=" -v "report" -n \
          			-o "lastcompleted=${lastcompleted}" -n \ ##RETAIN PARAMETER
          			-o "laststarted=${laststarted}" -n \ ##RETAIN PARAMETER
          			-o "laststatus=${laststatus}" -n \ ##RETAIN PARAMETER
          			-o "lastsize=${lastsize}" -n \ ##RETAIN PARAMETER
          			${OMV_CONFIG_FILE} | xmlstarlet unesc > ${filename}
#                -o "#!/bin/sh" -n \
#                -o "# This configuration file is auto-generated." -n \
#                -o "# WARNING: Do not edit this file, your changes will be lost." -n \
#                -o ". /usr/share/openmediavault/scripts/helper-functions" -n \
#                -o "cleanup() {" -n \
#                -o "  omv_kill_children \$\$" -n \
#                -o "  rm -f ${runfile}" -n \
#                -o "  exit" -n \
#                -o "}" -n \
#                -o "[ -e ${runfile} ] && exit 1" -n \
#                -v "concat('if ! omv_is_mounted \"${OMV_MOUNT_DIR}/',sharedfoldersource,'\" ; then')" -n \
#                -o "    echo \"Source storage device not mounted!\"" -n \
#                -o "    exit 1" -n \
#                -o "fi" -n \
#                -v "concat('if ! omv_is_mounted \"${OMV_MOUNT_DIR}/',sharedfoldertarget,'\" ; then')" -n \
#                -o "    echo \"Target storage device not mounted!\"" -n \
#                -o "    exit 1" -n \
#                -o "fi" -n \
#                -o "trap cleanup 0 1 2 5 15" -n \
#                -o "touch ${runfile}" -n \
#                  -o "# Create target directory on external storage device." -n \
#                  -v "concat('mkdir -p \"${OMV_MOUNT_DIR}/',sharedfoldertarget,'/')" ${OMV_XMLSTARLET_GET_SHAREDFOLDER_NAME} -o "\"" -n \
#                  -v "concat('chmod 777 \"${OMV_MOUNT_DIR}/',sharedfoldertarget,'/')" ${OMV_XMLSTARLET_GET_SHAREDFOLDER_NAME} -o "\"" -n \
#                -b \
#                -o "# Synchronise directories ..." -n \
#                -o "echo \"Please wait, syncing <" ${OMV_XMLSTARLET_GET_SHAREDFOLDER_PATH} -v "concat('> to <${OMV_MOUNT_DIR}/',sharedfoldertarget)" -i "usesubdir = '1'" -o "/" ${OMV_XMLSTARLET_GET_SHAREDFOLDER_NAME} -b -o "> ...\n\"" -n \
#                -o "rsync --verbose --log-file=\"${OMV_SBACKUP_LOGFILE}\"" \
#                -i "string-length(extraoptions) > 0" -v "concat(' ',extraoptions)" -b \
#                -i "mode = 'push'" -o " \"" ${OMV_XMLSTARLET_GET_SHAREDFOLDER_PATH} -o "/\"" -v "concat(' \"${OMV_MOUNT_DIR}/',sharedfoldertarget)" -i "usesubdir = '1'" -o "/" ${OMV_XMLSTARLET_GET_SHAREDFOLDER_NAME} -b -o "\"" -b \
#                -i "mode = 'pull'" -v "concat(' \"${OMV_MOUNT_DIR}/',sharedfoldertarget)" -i "usesubdir = '1'" -o "/" ${OMV_XMLSTARLET_GET_SHAREDFOLDER_NAME} -b -o "/\" \"" ${OMV_XMLSTARLET_GET_SHAREDFOLDER_PATH} -o "\"" -b \
#                -o " & wait \$!" \
#                ${OMV_CONFIG_FILE} | xmlstarlet unesc > ${filename}
#          chmod ${OMV_SBACKUP_SCRIPTS_MASK} ${filename}
  done
