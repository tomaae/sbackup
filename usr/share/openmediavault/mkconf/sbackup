#!/bin/sh

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

OMV_SBACKUP_SCRIPTS_DIR=${OMV_SBACKUP_SCRIPTS_DIR:-"/var/lib/openmediavault/sbackup.d"}
OMV_SBACKUP_SCRIPTS_MASK=${OMV_SBACKUP_SCRIPTS_MASK:-"755"}
OMV_SBACKUP_SESLOGDIR=${OMV_SBACKUP_SESLOGDIR:-"/var/log/sbackup/sessionlogs"}
OMV_SBACKUP_LOGFILE_GLOBAL=${OMV_SBACKUP_LOGFILE_GLOBAL:-"/var/log/sbackup/backup.log"}
mkdir -p ${OMV_SBACKUP_SESLOGDIR}

OMV_SBACKUP_CRONFILE=${OMV_SBACKUP_CRONFILE:-"/etc/cron.d/sbackup"}
echo "# This configuration file is auto-generated." > "${OMV_SBACKUP_CRONFILE}"
echo "# WARNING: Do not edit this file, your changes will be lost." >> "${OMV_SBACKUP_CRONFILE}"

# Create the backup jobs. Each job is configured in a separate script.
mkdir -p ${OMV_SBACKUP_SCRIPTS_DIR}
#rm -f ${OMV_SBACKUP_SCRIPTS_DIR}/config_*
rm -f ${OMV_SBACKUP_SCRIPTS_DIR}/backup_*
rm -f ${OMV_SBACKUP_SCRIPTS_DIR}/restore_*




# Create the scripts regardless if enabled or disabled.
xmlstarlet sel -t -m "//services/sbackup/backuplist/backup" \
  -v "uuid" \
  -i "position() != last()" -n -b \
  ${OMV_CONFIG_FILE} | xmlstarlet unesc |
  while read uuid; do
  	OMV_SBACKUP_LOGFILE=${OMV_SBACKUP_LOGFILE:-"/var/log/sbackup/history_" -v "uuid"}
  	
		GET_SOURCE_NAME=${GET_SOURCE_NAME=-m "//system/shares/sharedfolder[uuid=current()/sharedfoldersource]" -v "name" -b}
		GET_SOURCE_MNT=${GET_SOURCE_MNT=-m "//system/shares/sharedfolder[uuid=current()/sharedfoldersource]" -v "//system/fstab/mntent[uuid=current()/mntentref]/dir" -b}
		GET_SOURCE_PATH=${GET_SOURCE_PATH=-m "//system/shares/sharedfolder[uuid=current()/sharedfoldersource]" -v "concat(//system/fstab/mntent[uuid=current()/mntentref]/dir,'/',reldirpath)" -b}
		#GET_SOURCE_RELDIR=${GET_SOURCE_RELDIR=-m "//system/shares/sharedfolder[uuid=current()/sharedfoldersource]" -v "reldirpath" -b}
		
		GET_TARGET_NAME=${GET_TARGET_NAME=-m "//system/shares/sharedfolder[uuid=current()/sharedfoldertarget]" -v "name" -b}
		GET_TARGET_MNT=${GET_TARGET_MNT=-m "//system/shares/sharedfolder[uuid=current()/sharedfoldertarget]" -v "//system/fstab/mntent[uuid=current()/mntentref]/dir" -b}
		GET_TARGET_PATH=${GET_TARGET_PATH=-m "//system/shares/sharedfolder[uuid=current()/sharedfoldertarget]" -v "concat(//system/fstab/mntent[uuid=current()/mntentref]/dir,'/',reldirpath)" -b}
		#GET_TARGET_DEST=${GET_TARGET_DEST=${GET_TARGET_PATH} -o "/" ${GET_SOURCE_RELDIR}}
		GET_TARGET_DEST=${GET_TARGET_DEST=${GET_TARGET_PATH} -o "/sbackup_" -v "uuid" -o "/"}
		
		##Generate backup config
#		xmlstarlet sel -t -m "//services/sbackup/backuplist/backup[uuid='${uuid}']" \
#			-o "# This configuration file is auto-generated." -n \
#			-o "# WARNING: Do not edit this file, your changes will be lost." -n \
#			-o "uuid=" -v "uuid" -n \
#			-o "enable=" -v "enable" -n \
#			-o "wday=" -v "wday" -n \
#			-o "hour=" -v "hour" -n \
#			-o "minute=" -v "minute" -n \
#			-o "backup_source=" ${GET_SOURCE_PATH} -o "/"  -n \
#			-o "backup_target=" ${GET_TARGET_DEST} -o "/"  -n \
#			-o "target=" -v "sharedfoldertarget" -n \
#			${OMV_CONFIG_FILE} | xmlstarlet unesc > "${OMV_SBACKUP_SCRIPTS_DIR}/config-${uuid}"

    ##Generate backup script
 	 	runfile="/var/run/sbackup_${uuid}"
		xmlstarlet sel -t -m "//services/sbackup/backuplist/backup[uuid='${uuid}']" \
      -o "#!/bin/sh" -n \
      -o "# This configuration file is auto-generated." -n \
      -o "# WARNING: Do not edit this file, your changes will be lost." -n \
      -o ". /usr/share/openmediavault/scripts/helper-functions" -n \
      -o "SB_TIMESTART=\$(date +\"%s\")" -n \
      -o "cleanup() {" -n \
      -o "  omv_kill_children \$\$" -n \
      -o "  IFS='" -n \
      -o "'" -n \
      -o "  for line in \`echo \"\$RSOUT\"\`; do " -n \
      -o "    RSSIZE=\$(echo \${line}|awk '/^total size is / {print \$4}')" -n \
      -o "    RSPERF=\$(echo \${line}|awk '/^total size is / {print \$7}')" -n \
			-o "  done" -n \
			-o "  SB_TIMEEND=\$(date +\"%s\")" -n \
			-o "  if [ \"\${SB_ECODE}\" = \"\" ]; then" -n \
			-o "    SB_ECODE=-1" -n \
			-o "  fi" -n \
			-o "  cat \"" -o ${OMV_SBACKUP_LOGFILE} -o "\"|sed \"s/^running|\(.*\)|\(.*\)|\${SB_TIMESTART}||||backup|/\${SB_ECODE}|\1|\2|\${SB_TIMESTART}|\${SB_TIMEEND}|\${RSSIZE}|\${RSPERF}|backup|/g\" > \"" -o ${OMV_SBACKUP_LOGFILE} -o ".new\"" -n \
			-o "  mv \"" -o ${OMV_SBACKUP_LOGFILE} -o ".new\" \"" -o ${OMV_SBACKUP_LOGFILE} -o "\"" -n \
			-i "savelog = 1" -o "  echo \"\$RSOUT\n\nStart time: \$(date -d @\${SB_TIMESTART})\nEnd time: \$(date -d @\${SB_TIMEEND})\nStatus: \${SB_ECODE}\" >> \"" -o ${OMV_SBACKUP_SESLOGDIR} -o "/" -v "uuid" -o "_" -o "\${SB_TIMESTART}" -o ".log\"" -b -n \
      -o "  rm -f ${runfile}" -n \
      -o "  exit 0" -n \
      -o "}" -n \
      -o "# Check if backup is already running." -n \
      -o "[ -e ${runfile} ] && exit 1" -n \
      -o "# Check if all filesystems are mounted." -n \
      -o "if ! omv_is_mounted \"" ${GET_SOURCE_MNT} -o "\" ; then" -n \
      -o "  echo \"Source not mounted|" -v "name" -o "|" -v "uuid" -o "|\${SB_TIMESTART}||||backup|"  -o "\" >> \"" -o ${OMV_SBACKUP_LOGFILE} -o "\"" -n \
      -o "  exit 1" -n \
      -o "fi" -n \
      -o "if ! omv_is_mounted \"" ${GET_TARGET_MNT} -o "\" ; then" -n \
      -o "  echo \"Target not mounted|" -v "name" -o "|" -v "uuid" -o "|\${SB_TIMESTART}||||backup|"  -o "\" >> \"" -o ${OMV_SBACKUP_LOGFILE} -o "\"" -n \
      -o "  exit 1" -n \
      -o "fi" -n \
      -o "trap cleanup 0 1 2 5 9 15" -n \
      -o "echo \"backup|\" > ${runfile}" -n \
      -o "# Run backup" -n \
      -o "[ -e \"" -o ${OMV_SBACKUP_LOGFILE} -o "\" ] && LASTERR=\$(tail -1 \"" -o ${OMV_SBACKUP_LOGFILE} -o "\"|awk -F \"|\" '{print \$1}')" -n \
      -o "if [ \"\${LASTERR}\" != \"\" ]; then" -n \
			-o "  if [ \"\${LASTERR}\" != \"0\" ]; then" -n \
			-o "    LASTSTAMP=\$(tail -1 \"" -o ${OMV_SBACKUP_LOGFILE} -o "\"|awk -F \"|\" '{print \$4}')" -n \
			-o "    if [ -d \"" ${GET_TARGET_DEST} -o "/data_\${LASTSTAMP}\" ]; then" -n \
			-o "      mv \"" ${GET_TARGET_DEST} -o "/data_\${LASTSTAMP}\" \"" ${GET_TARGET_DEST} -o "/data_\${SB_TIMESTART}\"" -n \
			-o "    fi" -n \
      -o "  fi" -n \
      -o "  LASTSTAMP=\$(cat \"" -o ${OMV_SBACKUP_LOGFILE} -o "\"|grep \"^0|\"|tail -1|awk -F \"|\" '{print \$4}')" -n \
      -o "  if [ \"\${LASTSTAMP}\" != \"\" ]; then" -n \
      -o "    if [ \"\${LASTSTAMP}\" -gt \"100\" ]; then" -n \
      -o "      if [ -d \"" ${GET_TARGET_DEST} -o "/data_\${LASTSTAMP}\" ]; then" -n \
      -o "        INCR=--link-dest=\"" ${GET_TARGET_DEST} -o "/data_\${LASTSTAMP}/\"" -n \
      -o "      fi" -n \
      -o "    fi" -n \
      -o "  fi" -n \
      -o "fi" -n \
      -o "mkdir -p \"" ${GET_TARGET_DEST} -o "/data_\${SB_TIMESTART}/\"" -n \
      -o "chmod 777 \"" ${GET_TARGET_DEST} -o "/data_\${SB_TIMESTART}/\"" -n \
      -o "echo \"running|" -v "name" -o "|" -v "uuid" -o "|\${SB_TIMESTART}||||backup|"  -o "\" >> \"" -o ${OMV_SBACKUP_LOGFILE} -o "\"" -n \
      -o "RSOUT=\$(rsync --verbose" \
      -o " -aEAX --delete \${INCR}" \
      -o " \"" ${GET_SOURCE_PATH} -o "\"" -o " \"" ${GET_TARGET_DEST} -o "/data_\${SB_TIMESTART}/\" 2>&1)" -n \
      -o "SB_ECODE=\$(echo \$?)" -n \
      -o "sleep 5" -n \
    	${OMV_CONFIG_FILE} | xmlstarlet unesc > "${OMV_SBACKUP_SCRIPTS_DIR}/backup_${uuid}"
    chmod ${OMV_SBACKUP_SCRIPTS_MASK} "${OMV_SBACKUP_SCRIPTS_DIR}/backup_${uuid}"
    
    ##Generate cron
		xmlstarlet sel -t -m "//services/sbackup/backuplist/backup[uuid='${uuid}']" \
			-i "enable = 0" -o "#" -b \
      -v "minute" -o " " -v "hour" -o " * * " \
      -i "wday < 7" -v "wday" -b \
      -i "wday = 7" -o "*" -b \
      -o " root" -o " ${OMV_SBACKUP_SCRIPTS_DIR}/script-${uuid}" \
      ${OMV_CONFIG_FILE} | xmlstarlet unesc >> "${OMV_SBACKUP_CRONFILE}"
        
    ##Recreate laststatus&lastcompleted
  	#[ -e ${OMV_SBACKUP_LOGFILE} ] && cat ${OMV_SBACKUP_LOGFILE}|grep "|${uuid}|"|grep -v "|restore|"|awk -F'|' '{print $3"|"$4"|"$5"|"$6"|"$7"|"}'|tail -1 > "${OMV_SBACKUP_STATDIR}/laststatus-${uuid}"
  	#[ -e ${OMV_SBACKUP_LOGFILE} ] && cat ${OMV_SBACKUP_LOGFILE}|grep "|${uuid}|"|grep -v "|restore|"|awk -F'|' '{if ($5 == "0") print $3"|"$4"|"$5"|"$6"|"$7"|"}'|tail -1 > "${OMV_SBACKUP_STATDIR}/lastcompleted-${uuid}"
         
done
